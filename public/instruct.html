<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Additional styles if needed */
    .animate-spin {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body class="h-screen flex flex-col">
  <!-- Navbar -->
  <nav class="bg-white shadow-md">
    <div class="max-w-7xl mx-auto px-4">
      <div class="flex justify-start space-x-8 h-16 items-center">
        <div class="flex space-x-8">
          <a href="/public/instruct.html"
            class="text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">Instruct</a>
          <a href="/public/chat.html"
            class="text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">Chat</a>
          <a href="/public/files.html"
            class="text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">Files</a>
          <a href="/public/history.html"
            class="text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">History</a>
        </div>
      </div>
    </div>
  </nav>
  <div class="flex-1 h-full bg-gray-50">
    <div class="h-full mx-auto max-w-7xl">
      <div class="h-full rounded-lg bg-white p-4 shadow-lg flex flex-col">
        <form id="chatForm" method="post" class="h-full flex flex-col">
          <div class="flex flex-1 min-h-0 gap-4">
            <div class="flex-grow flex flex-col">
              <div class="flex-1 min-h-0">
                <textarea id="message" name="message"
                  class="h-full w-full rounded-lg border border-gray-300 p-4 focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 shadow-sm resize-none"
                  placeholder="Enter your message here...(Ctrl+Enter to submit)"></textarea>
              </div>
              <div id="error" class="text-red-500 mt-2" style="display: none;"></div>
              <div class="flex justify-end mt-2 pb-2">
                <button type="submit" id="submitButton"
                  class="inline-flex items-center rounded-lg bg-blue-600 px-6 py-2.5 text-sm font-medium text-white transition-colors hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:bg-gray-400 disabled:cursor-not-allowed shadow-sm">
                  Send
                </button>
              </div>
            </div>

            <div class="w-72 flex-shrink-0">
              <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 shadow-sm">
                <div class="space-y-4">
                  <div class="space-y-2">
                    <label for="model" class="block text-sm font-medium text-gray-700">Model</label>
                    <select id="model" name="model"
                      class="mt-1 block w-full rounded-md border border-gray-300 bg-white shadow-sm focus:border-blue-500 focus:ring-blue-500">
                      <option value="anthropic:sonnet" selected>anthropic:sonnet</option>
                      <option value="anthropic:haiku">anthropic:haiku</option>
                      <option value="openai:gpt-4o">openai:gpt-4o</option>
                      <option value="openai:gpt-4o-mini">openai:gpt-4o-mini</option>
                      <option value="openai:o1">openai:o1</option>
                      <option value="openai:o1-mini">openai:o1-mini</option>
                      <option value="google:pro">google:pro</option>
                      <option value="google:flash">google:flash</option>
                      <option value="google:flash2">google:flash2</option>
                      <option value="google:flash2thinking">google:flash2thinking</option>
                    </select>
                  </div>

                  <div class="space-y-2">
                    <label for="maxTokens" class="block text-sm font-medium text-gray-700">Max Tokens</label>
                    <input type="number" id="maxTokens" name="maxTokens" min="0" max="8192" step="1" value="8192"
                      class="mt-1 block w-full rounded-md border border-gray-300 bg-white shadow-sm focus:border-blue-500 focus:ring-blue-500">
                  </div>

                  <div class="space-y-2">
                    <label for="temperature" class="block text-sm font-medium text-gray-700">Temperature</label>
                    <input type="number" id="temperature" name="temperature" step="0.1" min="0" max="2" value="0.3"
                      class="mt-1 block w-full rounded-md border border-gray-300 bg-white shadow-sm focus:border-blue-500 focus:ring-blue-500">
                  </div>

                  <div class="space-y-2">
                    <label for="mode" class="block text-sm font-medium text-gray-700">Mode</label>
                    <select id="mode" name="mode"
                      class="mt-1 block w-full rounded-md border border-gray-300 bg-white shadow-sm focus:border-blue-500 focus:ring-blue-500">
                      <option value="instruct" selected>Normal</option>
                      <option value="bon">Best-of-N</option>
                      <option value="cot">Chain-of-Thought</option>
                      <option value="leap">LEAP</option>
                      <option value="moa">Mixture-of-Agent</option>
                      <option value="plansearch">Plansearch</option>
                      <option value="tot">Tree-of-Thought</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script type="module">
    const form = document.getElementById('chatForm');
    const messageTextarea = document.getElementById('message');
    const submitButton = document.getElementById('submitButton');
    const errorDiv = document.getElementById('error');

    let isLoading = false;

    function setLoading(loading) {
      isLoading = loading;
      submitButton.disabled = loading;
      if (loading) {
        submitButton.innerHTML = `
                    <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Processing...
                `;
      } else {
        submitButton.textContent = 'Send';
      }
    }

    function showError(message) {
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
    }

    function hideError() {
      errorDiv.style.display = 'none';
    }

    async function handleSubmit(e) {
      e.preventDefault();
      if (isLoading) return;

      const formData = new FormData(e.target);
      setLoading(true);
      hideError();

      const jsonBody = {
        message: formData.get('message'),
        model: formData.get('model'),
        maxTokens: Number(formData.get('maxTokens')),
        temperature: Number(formData.get('temperature')),
        mode: formData.get('mode')
      };

      console.dir(jsonBody);

      try {
        const response = await fetch('/instruct', {
          method: 'POST',
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(jsonBody)
        });

        const data = await response.json();
        messageTextarea.value = data.content;
      } catch (err) {
        console.error(err);
        showError('Failed to send message');
      } finally {
        setLoading(false);
      }
    }

    function handleKeyDown(e) {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        form.requestSubmit();
      }
    }

    form.addEventListener('submit', handleSubmit);
    messageTextarea.addEventListener('keydown', handleKeyDown);
  </script>
</body>

</html>