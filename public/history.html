<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="h-screen flex flex-col">
  <!-- Navbar -->
  <nav class="bg-white shadow-md">
    <div class="max-w-7xl mx-auto px-4">
      <div class="flex justify-start space-x-8 h-16 items-center">
        <div class="flex space-x-8">
          <a href="/public/instruct.html"
            class="text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">Instruct</a>
          <a href="/public/chat.html"
            class="text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">Chat</a>
          <a href="/public/files.html"
            class="text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">Files</a>
          <a href="/public/history.html"
            class="text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">History</a>
        </div>
      </div>
    </div>
  </nav>

  <div class="flex-1 h-full bg-gray-50">
    <div class="h-full mx-auto max-w-7xl">
      <div class="h-full rounded-lg bg-white p-4 shadow-lg flex flex-col">
        <!-- History List View -->
        <div id="historyList" class="flex-1">
          <div id="interactions" class="space-y-4"></div>
          <div class="mt-4 flex justify-center space-x-2" id="pagination"></div>
        </div>

        <!-- Detail View (initially hidden) -->
        <div id="detailView" class="flex-1 hidden">
          <button id="backButton" class="mb-4 text-blue-600 hover:text-blue-800">‚Üê Back to list</button>
          <div class="space-y-4">
            <div class="bg-gray-50 p-4 rounded-lg">
              <h3 class="font-medium text-gray-700 mb-2">Prompt:</h3>
              <p>
              <pre id="promptContent" class="text-gray-600"></pre>
              </p>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg">
              <h3 class="font-medium text-gray-700 mb-2">Response:</h3>
              <p>
              <pre id="responseContent" class="text-gray-600"></pre>
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import {marked} from "https://esm.run/marked";

    let currentPage = 1;
    const pageSize = 10;

    async function loadHistory(page) {
      try {
        const response = await fetch(`/history?page=${page}&pageSize=${pageSize}`);
        const data = await response.json();

        const interactionsDiv = document.getElementById('interactions');
        interactionsDiv.innerHTML = '';

        data.interactions.forEach(interaction => {
          const div = document.createElement('div');
          div.className = 'p-4 border rounded-lg hover:bg-gray-50 cursor-pointer';
          div.innerHTML = `
            <p class="text-gray-600">${interaction.preview}</p>
          `;
          div.onclick = () => loadDetail(interaction.id);
          interactionsDiv.appendChild(div);
        });

        // Update pagination
        const paginationDiv = document.getElementById('pagination');
        paginationDiv.innerHTML = '';

        for (let i = 1; i <= data.pagination.totalPages; i++) {
          const button = document.createElement('button');
          button.className = `px-3 py-1 rounded ${i === page ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'} hover:bg-blue-500 hover:text-white`;
          button.textContent = i;
          button.onclick = () => {
            currentPage = i;
            loadHistory(i);
          };
          paginationDiv.appendChild(button);
        }
      } catch (error) {
        console.error('Failed to load history:', error);
      }
    }

    async function loadDetail(id) {
      try {
        const response = await fetch(`/history/${id}`);
        const data = await response.json();

        // document.getElementById('promptContent').innerHTML = marked.parse(data.prompt);
        // document.getElementById('responseContent').innerHTML = marked.parse(data.message);
        document.getElementById('promptContent').textContent = data.prompt;
        document.getElementById('responseContent').textContent = data.message;

        document.getElementById('historyList').classList.add('hidden');
        document.getElementById('detailView').classList.remove('hidden');
      } catch (error) {
        console.error('Failed to load detail:', error);
      }
    }

    document.getElementById('backButton').onclick = () => {
      document.getElementById('historyList').classList.remove('hidden');
      document.getElementById('detailView').classList.add('hidden');
    };

    // Initial load
    loadHistory(currentPage);
  </script>
</body>

</html>